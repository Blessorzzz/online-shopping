from django.contrib.auth import login as auth_login
from django.contrib.auth.forms import AuthenticationForm
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from shoppingcart.models import Order
from ecommerce.models import Product
from .forms import ProductForm
from django.http import HttpResponseForbidden
from django.db.models import Q

def vendor_login(request):
    if request.method == 'POST':
        form = AuthenticationForm(request, data=request.POST)
        if form.is_valid():
            user = form.get_user()
            if hasattr(user, 'vendor'):
                auth_login(request, user)
                return redirect('vendor_dashboard')
            else:
                messages.error(request, "You are not a vendor.")
    else:
        form = AuthenticationForm()
    return render(request, 'registration/vendor_login.html', {'form': form})

# vendor search function
@login_required
def vendor_dashboard(request):
    if not hasattr(request.user, 'vendor'):
        return render(request, 'vendor/not_a_vendor.html')
    
    vendor = request.user.vendor
    query = request.GET.get('q', '').strip()  # Get search query from URL
    products = Product.objects.filter(vendor=vendor)  # Get all products for this vendor

    if query:
        products = products.filter(
            Q(product_name__icontains=query) |  # Search by product name (case-insensitive)
            Q(product_id__icontains=query)  # Search by product ID (case-insensitive)
        )

    return render(request, 'vendor/dashboard.html', {'vendor': vendor, 'products': products, 'query': query})

@login_required
def vendor_orders(request):
    if not hasattr(request.user, 'vendor'):
        return HttpResponseForbidden("You are not a vendor.")
    
    vendor = request.user.vendor
    # Query all orders that include products from the vendor
    orders = Order.objects.filter(items__product__vendor=vendor).distinct().order_by('-purchase_date')
    
    return render(request, 'vendor/vendor_orders.html', {'orders': orders})

@login_required
def add_product(request):
    if request.method == 'POST':
        form = ProductForm(request.POST, request.FILES)
        if form.is_valid():
            product = form.save(commit=False)
            product.vendor = request.user.vendor
            product.save()
            return redirect('vendor_dashboard')
    else:
        form = ProductForm()
    return render(request, 'vendor/add_product.html', {'form': form})

@login_required
def edit_product(request, product_id):
    product = get_object_or_404(Product, product_id=product_id)

    if request.method == 'POST':
        form = ProductForm(request.POST, request.FILES, instance=product)
        if form.is_valid():
            form.save()
            return redirect('vendor_dashboard')
    else:
        form = ProductForm(instance=product)

    return render(request, 'vendor/edit_product.html', {'form': form, 'product': product})

# Toggle the status of a product between active and inactive
@login_required
def toggle_product_status(request, product_id):
    product = get_object_or_404(Product, product_id=product_id)
    product.is_active = not product.is_active
    product.save()
    return redirect('vendor_dashboard')

# Display the details of an order
@login_required
def vendor_order_detail(request, order_id):
    if not hasattr(request.user, 'vendor'):
        return HttpResponseForbidden("You are not a vendor.")
    
    order = get_object_or_404(Order, id=order_id)
    order_items = order.items.all()  # Assuming 'items' is a related field in Order

    if request.method == 'POST':
        new_status = request.POST.get('status')
        if new_status in dict(Order.STATUS_CHOICES):
            order.status = new_status
            order.save()
            return redirect('vendor_order_detail', order_id=order.id)

    return render(request, 'vendor/vendor_order_detail.html', {'order': order, 'order_items': order_items.all})

@login_required
def vendor_product_detail(request, product_id):
    if not hasattr(request.user, 'vendor'):
        return HttpResponseForbidden("You are not a vendor.")
    
    product = get_object_or_404(Product, pk=product_id)
    return render(request, 'vendor/vendor_product_detail.html', {'product': product})

@login_required
def vendor_order_detail(request, order_id):
    order = get_object_or_404(Order, id=order_id)
    order_items = order.items.all()
    
    # 生成状态时间线数据
    status_date_map = {
        'pending': order.pending_date,
        'shipped': order.shipment_date,
        'cancelled': order.cancel_date,
        'hold': order.hold_date,
        'ticket-issued': order.ticket_issue_date,
        'complete': order.complete_date,
        'refunded': order.refund_date
    }
    
    # 过滤空值并按时间排序
    sorted_status_dates = sorted(
        [(status, date) for status, date in status_date_map.items() if date],
        key=lambda x: x[1]
    )

    if request.method == 'POST':
        new_status = request.POST.get('status')
        if new_status in dict(Order.STATUS_CHOICES):
            order.status = new_status
            order.save()
            return redirect('vendor_order_detail', order_id=order.id)

    return render(request, 'vendor/vendor_order_detail.html', {
        'order': order,
        'order_items': order_items,
        'sorted_status_dates': sorted_status_dates
    })

4.{% extends 'vendor/vendor_base.html' %}
{% load i18n %}
{% block content %}
<div class="order-detail-container" style="max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
    <h2 style="color: #333; margin-bottom: 20px;">{% trans "Order Details - PO Number:" %} {{ order.po_number }}</h2>
    <p><strong>{% trans "Customer:" %}</strong> {{ order.customer.username }}</p>
    <p><strong>{% trans "Purchase Date:" %}</strong> {{ order.purchase_date }}</p>
    <p><strong>{% trans "Total Amount:" %}</strong> ${{ order.total_amount }}</p>
    <p><strong>{% trans "Status:" %}</strong> {{ order.status }}</p>

    <h3 style="margin-top: 20px;">{% trans "Order Items" %}</h3>
    <table class="order-items-table" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">{% trans "Product Name" %}</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">{% trans "Quantity" %}</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">{% trans "Price" %}</th>
                <th style="border: 1px solid #ddd; padding: 8px; background-color: #f4f4f4;">{% trans "Subtotal" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for item in order_items %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 8px;">{{ item.product.product_name }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ item.quantity }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${{ item.product.price }}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${{ item.subtotal }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">{% trans "No items in this order." %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


    <form method="post" style="margin-top: 20px; text-align: center;">
        {% csrf_token %}
        <label for="status">{% trans "Change Order Status:" %}</label>
        <select name="status" id="status">
            {% for value, display in order.STATUS_CHOICES %}
            <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ display }}</option>
            {% endfor %}
        </select>
        <button type="submit" style="display: inline-block; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; transition: background 0.3s;">
            {% trans "Update Status" %}
        </button>
    </form>
    
    <div class="status-dates">
        <h4>{% trans "Status History" %}</h4>
        <div class="timeline">
            {% for status, date in sorted_status_dates %}
            <div class="timeline-item">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                    <div class="status-card">
                        <span class="status-label">{{ status|title }}:</span>
                        <span class="status-date">{{ date|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="no-history">{% trans "No status history available" %}</p>
            {% endfor %}
        </div>
    </div>
        {% comment %} <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            {% if order.shipment_date %}
            <div class="date-item">
                <span style="font-weight: 500;">{% trans "Shipped Date:" %}</span>
                {{ order.shipment_date|date:"Y-m-d H:i" }}
            </div>
            {% endif %}
            
            {% if order.cancel_date %}
            <div class="date-item">
                <span style="font-weight: 500;">{% trans "Cancelled Date:" %}</span>
                {{ order.cancel_date|date:"Y-m-d H:i" }}
            </div>
            {% endif %}
            
            {% if order.ticket_issue_date %}
            <div class="date-item">
                <span style="font-weight: 500;">{% trans "Ticket Issued Date:" %}</span>
                {{ order.ticket_issue_date|date:"Y-m-d H:i" }}
            </div>
            {% endif %}
            
            {% if order.refund_date %}
            <div class="date-item">
                <span style="font-weight: 500;">{% trans "Refund Date:" %}</span>
                {{ order.refund_date|date:"Y-m-d H:i" }}
            </div>
            {% endif %}

            {% if order.hold_date %}
            <div class="date-item">
                <span style="font-weight: 500;">{% trans "hold_date:" %}</span>
                {{ order.hold_date|date:"Y-m-d H:i" }}
            </div>
            {% endif %}

            {% if order.complete_date %}
            <div class="date-item">
                <span style="font-weight: 500;">{% trans "complete_date:" %}</span>
                {{ order.complete_date|date:"Y-m-d H:i" }}
            </div>
            {% endif %}

            {% if order.pending_date %}
            <div class="date-item">
                <span style="font-weight: 500;">{% trans "pending_date:" %}</span>
                {{ order.pending_date|date:"Y-m-d H:i" }}
            </div>
            {% endif %} {% endcomment %}
        </div>
    </div>

    <div style="margin-top: 20px; text-align: center;">
        <a href="{% url 'vendor_orders' %}" class="back-to-orders-button" style="display: inline-block; padding: 10px 20px; background-color: #ED7014; color: white; text-decoration: none; border-radius: 5px; transition: background 0.3s;">
            {% trans "Back to Orders" %}
        </a>
    </div>    
</div>

<style>
    .timeline {
        position: relative;
        padding: 20px 0;
        margin-left: 30px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #007bff;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 40px;
    }
    
    .timeline-marker {
        position: absolute;
        left: 6px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #007bff;
        z-index: 1;
    }
    
    .timeline-content {
        position: relative;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #dee2e6;
        transition: transform 0.2s;
    }
    
    .status-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .status-label {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .status-date {
        color: #7f8c8d;
        font-size: 0.9em;
    }
    
    .no-history {
        color: #95a5a6;
        text-align: center;
        padding: 20px;
    }
</style>
{% endblock %}
