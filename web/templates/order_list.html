{% extends "base.html" %}
{% block content %}
{% load static i18n %}

<main role="main" aria-label="{% trans 'Order List Page' %}">

    <h2>{% trans "My Orders" %}</h2>

    <!-- ç­›é€‰å™¨ -->
    <form method="get" action="." class="filter-form" role="search" aria-label="{% trans 'Filter Orders By Status' %}">
        <label for="status">{% trans "Filter by status:" %}</label>
        <select name="status" id="status" aria-label="{% trans 'Order Status' %}">
            <option value="" {% if not request.GET.status %}selected{% endif %}>{% trans "All" %}</option>
            <option value="pending" {% if request.GET.status == "pending" %}selected{% endif %}>{% trans "Pending" %}</option>
            <option value="shipped" {% if request.GET.status == "shipped" %}selected{% endif %}>{% trans "Shipped" %}</option>
            <option value="cancelled" {% if request.GET.status == "cancelled" %}selected{% endif %}>{% trans "Cancelled" %}</option>
            <option value="hold" {% if request.GET.status == "hold" %}selected{% endif %}>{% trans "Hold" %}</option>
            <option value="ticket-issued" {% if request.GET.status == "ticket-issued" %}selected{% endif %}>{% trans "Ticket Issued" %}</option>
            <option value="complete" {% if request.GET.status == "complete" %}selected{% endif %}>{% trans "Complete" %}</option>
            <option value="refunded" {% if request.GET.status == "refunded" %}selected{% endif %}>{% trans "Refunded" %}</option>
            <option value="delivered" {% if request.GET.status == "delivered" %}selected{% endif %}>{% trans "Delivered" %}</option>
        </select>
        <button type="submit" aria-label="{% trans 'Filter Orders' %}">{% trans "Filter" %}</button>
    </form>

    <!-- è®¢å•è¡¨æ ¼ -->
    <section aria-label="{% trans 'Order Table' %}">
        <table class="order-table" role="table">
            <thead>
                <tr>
                    <th scope="col">{% trans "P.O. Number" %}</th>
                    <th scope="col">{% trans "Purchase Date" %}</th>
                    <th scope="col">{% trans "Total Amount" %}</th>
                    <th scope="col">{% trans "Status" %}</th>
                    <th scope="col">{% trans "Actions" %}</th>
                    <th scope="col">{% trans "Reviews" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr class="clickable-row" data-href="{% url 'order_detail' order.id %}" tabindex="0"
                    role="button" aria-label="{% trans 'View details for order' %} {{ order.po_number }}">
                    <td>{{ order.po_number }}</td>
                    <td>{{ order.purchase_date|date:"DATETIME_FORMAT" }}</td>
                    <td>${{ order.total_amount }}</td>
                    <td class="status">
                        <span class="status-label status-{{ order.status }}" aria-label="{{ order.status|capfirst }}">
                            {% if order.status == 'pending' %}â³ Pending
                            {% elif order.status == 'shipped' %}ğŸ“¦ Shipped
                            {% elif order.status == 'cancelled' %}âŒ Cancelled
                            {% elif order.status == 'hold' %}â¸ï¸ Hold
                            {% elif order.status == 'ticket-issued' %}ğŸ« Ticket Issued
                            {% elif order.status == 'complete' %}âœ… Complete
                            {% elif order.status == 'refunded' %}ğŸ’° Refunded
                            {% elif order.status == 'delivered' %}ğŸ“¬ Delivered
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if order.status == 'pending' or order.status == 'hold' %}
                        <form method="post" action="{% url 'cancel_order' order.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger"
                                    aria-label="{% trans 'Cancel order' %} {{ order.po_number }}">
                                {% trans "Cancel" %}
                            </button>
                        </form>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.status in "complete refunded delivered" %}
                        <a href="{% url 'add_review' order.id %}" class="btn btn-primary"
                           aria-label="{% trans 'Add a review for order' %} {{ order.po_number }}">
                            {% trans "Add a Review" %}
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    {% if messages %}
    <div class="popup-message" id="popup-message" role="alert" aria-live="polite">
        {% for message in messages %}
            <p class="message {{ message.tags }}">{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".clickable-row").forEach(row => {
                row.addEventListener("click", function () {
                    window.location.href = this.dataset.href;
                });
                row.addEventListener("keypress", function (e) {
                    if (e.key === "Enter" || e.key === " ") {
                        this.click();
                    }
                });
            });

            const popupMessage = document.getElementById('popup-message');
            if (popupMessage) {
                popupMessage.style.display = 'block';
                setTimeout(() => popupMessage.style.display = 'none', 5000);
            }
        });
    </script>
</main>
{% endblock %}
